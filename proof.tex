\documentclass{article}
\usepackage[utf8]{inputenc}
% \usepackage[margin=2.5cm]{geometry}
% \pagestyle{plain}
\include{preamble.tex}
\usepackage{amsmath, amssymb, amsthm}

\begin{document}

\section*{Confirmation Rule: Safety}

See:
\begin{itemize}
    \item \href{https://github.com/mkalinin/confirmation-rule}{https://github.com/mkalinin/confirmation-rule}
    \item \href{https://arxiv.org/abs/2405.00549}{https://arxiv.org/abs/2405.00549}
\end{itemize}

\begin{definition}[LMD-GHOST Safety condition for a single block]
    Given $C \in AU(b):$
    \[
    \isOneConfirmed_v(b, C, t) := Q^{\slot(t)-1,\ v,\ t,\ C}_{b} > \frac{1}{2}\left(1 + \frac{W^C_p}{W^{\slot(t)-1,\ C}_b}\right)
    \]
\end{definition}


\begin{algorithm}[H]
\caption{Highest LMD-GHOST confirmed descendant}
\SetAlgoNoLine
\Fn{\highestLMDConfirmedDesc$_v(\banchor, t)$}{
    blocks $\gets \left\{b'' \in \viewattime[time=t,val=v] : \banchor \preceq b'' \preceq \LMDGHOSTHFC(\viewattime[time=t,val=v], t)\right\}$\;
    
    \Return{$\max\left(\left\{b' \in \text{blocks} : \forall b'' \in \text{blocks}, b'' \preceq b' \Rightarrow \isOneConfirmed_v(b'', GJ^{\slotstart(\slot(t) - 1),v}, t)\right\}\right)$}\;
}
\end{algorithm}


\begin{lemma}
If $t$ and $t'$ are any two times, $b := \highestLMDConfirmedDesc_v(\banchor, t)$, $t \leq t'$ and the following holds:
\begin{enumerate}
    \item $\slotstart(\slot(t) - 1) \geq \GST,$
    \item $\banchor$ is canonical in the view of any honest validator $v'$ at time $t,$
    \item $\gjattime[time=t',val=v] \succeq \gjattime[time=\slotstart(\slot(t) - 1),val=v],$
    \item $b \in \filtered[time=t',val=v']$
\end{enumerate}

then $b$ is canonical in the view of any honest validator $v'$ at time $t'$.
\end{lemma}

\begin{proof}
    TBD..
\end{proof}


\begin{algorithm}[H]
\caption{Highest confirmed descendant}
% \SetAlgoLined
\SetAlgoNoLine
\Fn{highestConfirmedDesc$_v(\banchor, t)$}{
    $b' \gets \highestLMDConfirmedDesc_v(\banchor, t)$\;
    
    \uIf{$\epoch(t) = \epoch(b') > \epoch(\banchor)$}{
        \uIf{$\willChkpBeJustified_v(\chkp(b'))$ \textbf{and} $\exists b'' \succeq b' : \epoch(\gu(b'')) \geq \epoch(t) - 1$}{
            \Return{$b'$}\;
        }
        \uElse{
            \Return{$\max\left(\left\{b'' \in \viewattime[time=t,val=v] : \banchor \preceq b'' \prec b' \wedge \epoch(b'') = \epoch(\banchor)\right\}\right)$}\;
        }
    }
    \uElseIf{$\epoch(t) = \epoch(b') = \epoch(\banchor)$}{
        \uIf{$\exists b'' \succeq b' : \epoch(\gu(b'')) \geq \epoch(t) - 1$}{
            \Return{$b'$}\;
        }
        \uElse{
            \Return{$\banchor$}\;
        }
    }
    \uElseIf{$\epoch(t) > \epoch(b')$ \textbf{and} $\slot(t) = \text{first\_slot}(\epoch(t))$}{
        \uIf{$\epoch(\gu(b')) \geq \epoch(t) - 2$}{
            \Return{$b'$}\;
        }
        \uElse{
            \Return{$\banchor$}\;
        }
    }
    \uElse{
        \Return{$b'$}\;
    }
}
\end{algorithm}

\begin{lemma}
If $t$ and $t'$ are any two times such that $t' \geq t \wedge \epoch(t') = \epoch(t)$, $b := \text{highestConfirmedDesc}_v(\banchor, t)$, $\epoch(b) = \epoch(t) - 1$ and the following holds:

\begin{enumerate}
    \item $\slotstart(\epoch(t) - 1) \geq \GST,$
    \item $\banchor, \epoch(\banchor) = \epoch(t) - 1$ is canonical in the view of any validator $v'$ at time $\slotstart(\slot(t) - 1),$
    \item At the time $t'' \leq \slotstart(\lastslot(\epoch(t) - 1))$ in the view of validator $v$ exists block $b' \preceq b : \epoch(b') = \epoch(t) - 1$ such that $\willChkpBeJustified^{t''}_v(\chkp(b')) = \True,$
    \item At the time $\slotstart(\slot(t) - 1)$ $\exists b'' \succeq \banchor : \epoch(b'') = \epoch(t) - 1 \wedge \epoch(\gu(b'')) \geq \epoch(t) - 2,$
    \item $\gjattime[time=\slotstart(\lastslot(\epoch(t) - 1)),val=v] = \chkp(b, *)$
\end{enumerate}

then $b$ is canonical in the view of any honest validator $v'$ at time $t' < \slotstart(\epoch(b) + 2)$.
\end{lemma}

\begin{proof}
    TBD...
\end{proof}



\begin{lemma}
   If $t$ and $t'$ are any two times such that $t' \geq t$, $b := \text{highestConfirmedDesc}_v(\banchor, t)$, $\epoch(b) = \epoch(t)$ and the following holds:
    
    \begin{enumerate}
        \item $\slotstart(\epoch(t') - 1) \geq \GST,$
        \item $\banchor$ is canonical in the view of any validator $v'$ at time $t,$
        \item At the time $t'' \leq \slotstart(\lastslot(\epoch(t)))$ in the view of validator $v$ exists block $b' \preceq b : \epoch(b') = \epoch(t)$ such that:
        \begin{enumerate}
            \item $willChkpBeJustified^{t''}_v(\chkp(b')),$
            \item $\exists b'' \succeq b' : \epoch(b'') = \epoch(t) \wedge \epoch(\gu(b'')) \geq \epoch(t) - 1,$
        \end{enumerate}
        \item $\guattime[time=\slotstart(\lastslot(\epoch(t) - 1)),val=v] \succeq \chkp(b, \epoch(t) - 2),$
        \item $\gjattime[time=\slotstart(\lastslot(\epoch(t) - 1)),val=v] = \chkp(b, *),$
    \end{enumerate}
    
    then $b$ is canonical in the view of any honest validator $v'$ at time $t' < \slotstart(\epoch(b) + 2)$.
\end{lemma}

\begin{proof}
    TBD...
\end{proof}

% \section*{Algorithm 102}
% \textbf{(Highest confirmed)}

Let $\viewatstslottime[val=v,time=t]$ be the view of a validator $v$ at the start of $\slot(t)$ to which all the votes cast and observed by $v$ before $\slotstart(\slot(t))$ are applied.

\begin{algorithm}[H]
\SetAlgoNoLine
\Fn{$\text{highestConfirmed}_v(\viewatstslottime[val=v,time=t])$}{
    $b' \gets \text{highestConfirmed}(\viewatstslottime[val=v, time=\slotstart(\slot(t) - 1)])$\;
    \uIf{$b' \preceq \LMDGHOSTHFC(\viewatstslottime[val=v,time=t])$ \textbf{and} $\epoch(b') \geq \epoch(t) - 1$}{
        \Return{$\text{highestConfirmedDesc}_v(b', t)$}\;
    }
    \uElseIf{
        $\epoch(\gu(\viewatstslottime[val=v,time=t])) = \epoch(t)$ \textbf{and} \\
        $\epoch(\gjview[view={\viewattime[val=v, time=\slotstart(\slot(t) - 1)]}]) = \epoch(t) - 1$ \textbf{and} \\
        $\gu(\viewatstslottime[val=v,time=t]) \succeq \gjattime[time=\slotstart(\slot(t) - 1), val=v]$
    }{
        \Return{$\text{highestConfirmedDesc}_v(\text{block}(\gu(\viewatstslottime[val=v,time=t])), t)$}\;
    }
    \uElse{
        \Return{$b_{\text{fin}}$}\;
    }
}
\caption{Highest Confirmed Block Selection}
\end{algorithm}

\begin{lemma}
    If $t$ and $t'$ are any two times such that $t' \geq t$, $b := \text{highestConfirmed}(\viewatstslottime[val=v,time=t])$ and the following holds:
    
    \begin{enumerate}
        \item $\slotstart(\epoch(t) - 1) \geq \GST,$
    \end{enumerate}
    
    then $b$ is canonical in the view of any honest validator $v'$ at time $t'$.
\end{lemma}

\begin{proof}
    TBD...
\end{proof}


\begin{lemma}
    If $t$ and $t'$ are any two times such that $t' \geq t$ and the following holds:
    
    \begin{enumerate}
        \item $\slotstart(\epoch(t')) \geq \GST,$
        \item $\epoch(\guattime[time=t,val=v]) = \epoch(t),$
        \item $\epoch(\gjattime[time=\slotstart(\slot(t)-1),val=v]) = \epoch(t) - 1,$
        \item $\guattime[time=t,val=v] \succeq \gjattime[time=\slotstart(\slot(t)-1),val=v],$
    \end{enumerate}
    
then $\guattime[time=t,val=v]$ is canonical in the view of any honest validator $v'$ at any time $t'$.
\end{lemma}

\begin{proof}
    TBD...

    \begin{description}
        \item[Case 1: $\epoch(t') = \epoch(t)$.]
        \item[Case 2: $\epoch(t') > \epoch(t)$.]  
    \end{description}
\end{proof}

\subsection*{Roberto's suggested Lemmas}

\begin{lemma}
    If
    \begin{enumerate}
        \item $epoch(b_{\text{anchor}}^{v,st(slot(t))}) \geq epoch(t)-2$
    \end{enumerate},
    then
    \begin{enumerate}
        \item $epoch(GJ^{v,st(slot(t))}) \geq epoch(t)-2$
        % \item $b_{\text{anchor}}^{v,st(slot(t))} \succeq GJ^{v,t}$
    \end{enumerate}
\end{lemma}

\begin{lemma}
    If
    \begin{enumerate}
        \item $\text{st}(\text{last\_slot}(\text{epoch}(t) - 1)) \geq GST$
        \item $epoch(b_{\text{anchor}}^{v,st(slot(t))}) \geq epoch(t)-2$
    \end{enumerate},
    then, for any honest validator $v'$,
    \begin{enumerate}
        \item $epoch(GJ^{v',st(slot(t))}) \geq epoch(t)-2$
    \end{enumerate}
\end{lemma}

\begin{lemma}\label{lem:gj-at-least-e-2}
    If
    \begin{enumerate}
        \item $\text{st}(\text{last\_slot}(\text{epoch}(t) - 1)) \geq GST$
        \item $slot(t) > \text{first\_slot}(epoch(t))$
        \item $epoch(b_{\text{anchor}}^{v,st(slot(t))}) \geq epoch(t)-2$
    \end{enumerate},
    then, for any honest validator $v'$,
    \begin{enumerate}
        \item $epoch(GJ^{v',st(slot(t)-1)}) \geq epoch(t)-2$
    \end{enumerate}
\end{lemma}

\begin{lemma}
    If
    \begin{enumerate}
        \item $\text{isOneConfirmed}_v(b, GJ^{v,st(slot(t))}, st(slot(t)))$
        \item $epoch(b) = epoch(t)$
    \end{enumerate},
    then, for any honest validator $v'$ and time $t' \geq t$ such that $epoch(t') = epoch(t)$
    \begin{enumerate}
        \item $b \in \text{filt}^{t',v'}_{\text{hfc}}$
    \end{enumerate}
\end{lemma}

\begin{proof}(Sketch)
    At least one honest validator $v'$ voted for $b$ in the previous slot.
    This also implies that $slot(t) > first_slot(epoch(t))$. 
    Given, \Cref{lem:gj-at-least-e-2} and that $epoch(slot(t)-1) = epoch(t)$,  it must be that $v'$'s view includes a block $b' \succeq b$ such that $epoch(vs(b', st(slot(t)-1))) \geq epoch(t)-2$.
    By $st(slot(t))$, $b'$ is in the view of any honest validator.
    Hence, $b'$ is not filtered out by any honest validator at time $st(slot(t))$ or after during epoch $epoch(t)$.
\end{proof}

\begin{lemma}
    Let $GU^{v,t-1} := GU(V^{v,st(slot(t)-1)},st(slot(t)-1))$.
    If
    \begin{enumerate}
        \item $t = st(epoch(t))$
        \item $epoch(GU^{v,t-1}) = epoch(t)-1$
    \end{enumerate},
    then for any honest validator $v'$ and time $t'$ such that $epoch(t') \in \{epoch(t),epoch(t)+1\}$,
    \begin{enumerate}
        \item $b \in \text{filt}^{t',v'}_{\text{hfc}}$
    \end{enumerate}
\end{lemma}



\end{document}