\documentclass{article}
\usepackage{amsmath, amssymb, amsthm}
\usepackage{hyperref}

\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}


\begin{document}

\section*{Confirmation Rule: Safety}

See:
\begin{itemize}
    \item \href{https://github.com/mkalinin/confirmation-rule}{https://github.com/mkalinin/confirmation-rule}
    \item \href{https://arxiv.org/abs/2405.00549}{https://arxiv.org/abs/2405.00549}
\end{itemize}

\begin{definition}[LMD-GHOST Safety condition for a single block]
    Given $C \in AU(b):$
    \[
    \text{isOneConfirmed}_v(b, C, t) := Q^{\text{slot}(t)-1,\ v,\ t,\ C}_{b} > \frac{1}{2}\left(1 + \frac{W^C_p}{W^{\text{slot}(t)-1,\ C}_b}\right)
    \]
\end{definition}

\section*{Algorithm 100}
\textbf{(Highest LMD-GHOST confirmed descendant)}

\begin{enumerate}
    \item \textbf{function} highestLMDConfirmedDesc$_v(b_{\text{anchor}}, t)$
    \item \quad \textbf{let} blocks = $\{b'' \in \nu^{v,t} : b_{\text{anchor}} \preceq b'' \preceq \text{LMD\_GHOST\_HFC}(\nu, t)\}$
    \item \quad \textbf{return} $\max(\{b' \in \text{blocks} : \forall b'' \in \text{blocks} \wedge b'' \preceq b', \text{isOneConfirmed}_v(b'', GJ^{\text{st}(\text{slot}(t) - 1),v}, t)\})$
\end{enumerate}

\begin{lemma}
If $t$ and $t'$ are any two times, $b := \text{highestLMDConfirmedDesc}_v(b_{\text{anchor}}, t)$, $t \leq t'$ and the following holds:
\begin{enumerate}
    \item $\text{st}(\text{slot}(t) - 1) \geq \text{GST},$
    \item $b_{\text{anchor}}$ is canonical in the view of any honest validator $v'$ at time $t,$
    \item $GJ^{t',v} \succeq GJ^{\text{st}(\text{slot}(t) - 1),v},$
    \item $b \in \text{filt}^{t',v'}_{\text{hfc}}$
\end{enumerate}

then $b$ is canonical in the view of any honest validator $v'$ at time $t'$.
\end{lemma}

\begin{proof}
    TBD..
\end{proof}

\section*{Algorithm 101}
\textbf{(Highest confirmed descendant)}

\begin{enumerate}
    \item \textbf{function} highestConfirmedDesc$_v(b_{\text{anchor}}, t)$
    \item \quad \textbf{let} $b' = \text{highestLMDConfirmedDesc}_v(b_{\text{anchor}}, t)$
    \item \quad \textbf{if} $\text{epoch}(t) = \text{epoch}(b') > \text{epoch}(b_{\text{anchor}})$
    \item \quad \quad \textbf{if} $\wedge \text{willChkpBeJustified}_v(C(b'))$
    \item \quad \quad \quad $\wedge \exists b'' \succeq b' : \text{epoch}(GU(b'')) \geq \text{epoch}(t) - 1$
    \item \quad \quad \quad \quad \textbf{return} $b'$
    \item \quad \quad \textbf{else}
    \item \quad \quad \quad \quad \textbf{return} $\max(\{b'' \in \nu^{v,t} : b_{\text{anchor}} \preceq b'' \prec b' \wedge \text{epoch}(b'') = \text{epoch}(b_{\text{anchor}})\})$
    \item \quad \textbf{elif} $\text{epoch}(t) = \text{epoch}(b') = \text{epoch}(b_{\text{anchor}})$
    \item \quad \quad \textbf{if} $\exists b'' \succeq b' : \text{epoch}(GU(b'')) \geq \text{epoch}(t) - 1$
    \item \quad \quad \quad \textbf{return} $b'$
    \item \quad \quad \textbf{else}
    \item \quad \quad \quad \textbf{return} $b_{\text{anchor}}$
    \item \quad \textbf{elif} $\text{epoch}(t) > \text{epoch}(b') \wedge \text{slot}(t) = \text{first\_slot}(\text{epoch}(t))$
    \item \quad \quad \textbf{if} $\text{epoch}(GU(b')) \geq \text{epoch}(t) - 2$
    \item \quad \quad \quad \textbf{return} $b'$
    \item \quad \quad \textbf{else}
    \item \quad \quad \quad \textbf{return} $b_{\text{anchor}}$
    \item \quad \textbf{else}
    \item \quad \quad \textbf{return} $b'$
\end{enumerate}

\begin{lemma}
If $t$ and $t'$ are any two times such that $t' \geq t \wedge \text{epoch}(t') = \text{epoch}(t)$, $b := \text{highestConfirmedDesc}_v(b_{\text{anchor}}, t)$, $\text{epoch}(b) = \text{epoch}(t) - 1$ and the following holds:

\begin{enumerate}
    \item $\text{st}(\text{epoch}(t) - 1) \geq \text{GST},$
    \item $b_{\text{anchor}}, \text{epoch}(b_{\text{anchor}}) = \text{epoch}(t) - 1$ is canonical in the view of any validator $v'$ at time $\text{st}(\text{slot}(t) - 1),$
    \item At the time $t'' \leq \text{st}(\text{last\_slot}(\text{epoch}(t) - 1))$ in the view of validator $v$ exists block $b' \preceq b : \text{epoch}(b') = \text{epoch}(t) - 1$ such that $\text{willChkpBeJustified}^{t''}_v(C(b')) = \text{True},$
    \item At the time $\text{st}(\text{slot}(t) - 1)$ $\exists b'' \succeq b_{\text{anchor}} : \text{epoch}(b'') = \text{epoch}(t) - 1 \wedge \text{epoch}(GU(b'')) \geq \text{epoch}(t) - 2,$
    \item $GJ^{\text{st}(\text{last\_slot}(\text{epoch}(t) - 1)),v} = C(b, *)$
\end{enumerate}

then $b$ is canonical in the view of any honest validator $v'$ at time $t' < \text{st}(\text{epoch}(b) + 2)$.
\end{lemma}

\begin{proof}
    TBD...
\end{proof}



\begin{lemma}
   If $t$ and $t'$ are any two times such that $t' \geq t$, $b := \text{highestConfirmedDesc}_v(b_{\text{anchor}}, t)$, $\text{epoch}(b) = \text{epoch}(t)$ and the following holds:
    
    \begin{enumerate}
        \item $\text{st}(\text{epoch}(t') - 1) \geq \text{GST},$
        \item $b_{\text{anchor}}$ is canonical in the view of any validator $v'$ at time $t,$
        \item At the time $t'' \leq \text{st}(\text{last\_slot}(\text{epoch}(t)))$ in the view of validator $v$ exists block $b' \preceq b : \text{epoch}(b') = \text{epoch}(t)$ such that:
        \begin{enumerate}
            \item $willChkpBeJustified^{t''}_v(C(b')),$
            \item $\exists b'' \succeq b' : \text{epoch}(b'') = \text{epoch}(t) \wedge \text{epoch}(GU(b'')) \geq \text{epoch}(t) - 1,$
        \end{enumerate}
        \item $GU^{\text{st}(\text{last\_slot}(\text{epoch}(t) - 1)),v} \succeq C(b, \text{epoch}(t) - 2),$
        \item $GJ^{\text{st}(\text{last\_slot}(\text{epoch}(t) - 1)),v} = C(b, *),$
    \end{enumerate}
    
    then $b$ is canonical in the view of any honest validator $v'$ at time $t' < \text{st}(\text{epoch}(b) + 2)$.
\end{lemma}

\begin{proof}
    TBD...
\end{proof}

\section*{Algorithm 102}
\textbf{(Highest confirmed)}

Let $V^{v,t}$ be the view of a validator $v$ at the start of $\text{slot}(t)$ to which all the votes cast and observed by $v$ before $\text{st}(\text{slot}(t))$ are applied.

\begin{enumerate}
    \item \textbf{function} highestConfirmed$_v(V^{v,t})$
    \item \quad \textbf{let} $b' = \text{highestConfirmed}(V^{v, \text{st}(\text{slot}(t) - 1)})$
    \item \quad \textbf{if} $\wedge b' \preceq \text{LMD\_GHOST\_HFC}(V^{v, t})$
    \item \quad \quad $\wedge \text{epoch}(b') \geq \text{epoch}(t) - 1$
    \item \quad \quad \quad \textbf{return} $\text{highestConfirmedDesc}_v(b', t)$
    \item \quad \textbf{else}
    \item \quad \quad \textbf{if} $\wedge \text{epoch}(GU(V^{v, t})) = \text{epoch}(t)$
    \item \quad \quad \quad $\wedge \text{epoch}(GJ(V^{v, \text{st}(\text{slot}(t) - 1)})) = \text{epoch}(t) - 1$
    \item \quad \quad \quad $\wedge GU(V^{v,t}) \succeq GJ^{\text{st}(\text{slot}(t) - 1), v}$
    \item \quad \quad \quad \quad \textbf{return} $\text{highestConfirmedDesc}_v(\text{block}(GU(V^{v,t})), t)$
    \item \quad \quad \textbf{else}
    \item \quad \quad \quad \textbf{return} $b_{\text{fin}}$
\end{enumerate}

\begin{lemma}
    If $t$ and $t'$ are any two times such that $t' \geq t$, $b := \text{highestConfirmed}(V^{v,t})$ and the following holds:
    
    \begin{enumerate}
        \item $\text{st}(\text{epoch}(t) - 1) \geq \text{GST},$
    \end{enumerate}
    
    then $b$ is canonical in the view of any honest validator $v'$ at time $t'$.
\end{lemma}

\begin{proof}
    TBD...
\end{proof}


\begin{lemma}
    If $t$ and $t'$ are any two times such that $t' \geq t$ and the following holds:
    
    \begin{enumerate}
        \item $\text{st}(\text{epoch}(t')) \geq \text{GST},$
        \item $\text{epoch}(GU^{t,v}) = \text{epoch}(t),$
        \item $\text{epoch}(GJ^{\text{st}(\text{slot}(t)-1),v}) = \text{epoch}(t) - 1,$
        \item $GU^{t,v} \succeq GJ^{\text{st}(\text{slot}(t)-1),v},$
    \end{enumerate}
    
then $GU^{t,v}$ is canonical in the view of any honest validator $v'$ at any time $t'$.
\end{lemma}

\begin{proof}
    TBD...

    \begin{description}
        \item[Case 1: $\text{epoch}(t') = \text{epoch}(t)$.]
        \item[Case 2: $\text{epoch}(t') > \text{epoch}(t)$.]  
    \end{description}
\end{proof}

\end{document}