\documentclass{article}
\usepackage{amsmath, amssymb, amsthm}
\usepackage{hyperref}
\usepackage[linesnumbered,ruled]{algorithm2e}
\usepackage{cleveref}
\SetKwProg{Fn}{function}{}{end}
\SetNlSty{textbf}{}{:}


\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}


\begin{document}

\section*{Confirmation Rule: Safety}

See:
\begin{itemize}
    \item \href{https://github.com/mkalinin/confirmation-rule}{https://github.com/mkalinin/confirmation-rule}
    \item \href{https://arxiv.org/abs/2405.00549}{https://arxiv.org/abs/2405.00549}
\end{itemize}

\begin{definition}[LMD-GHOST Safety condition for a single block]
    Given $C \in AU(b):$
    \[
    \text{isOneConfirmed}_v(b, C, t) := Q^{\text{slot}(t)-1,\ v,\ t,\ C}_{b} > \frac{1}{2}\left(1 + \frac{W^C_p}{W^{\text{slot}(t)-1,\ C}_b}\right)
    \]
\end{definition}


\begin{algorithm}[H]
\caption{Highest LMD-GHOST confirmed descendant}
\SetAlgoNoLine
\Fn{highestLMDConfirmedDesc$_v(b_{\text{anchor}}, t)$}{
    blocks $\gets \left\{b'' \in \nu^{v,t} : b_{\text{anchor}} \preceq b'' \preceq \text{LMD\_GHOST\_HFC}(\nu, t)\right\}$\;
    
    \Return{$\max\left(\left\{b' \in \text{blocks} : \forall b'' \in \text{blocks}, b'' \preceq b' \Rightarrow \text{isOneConfirmed}_v(b'', GJ^{\text{st}(\text{slot}(t) - 1),v}, t)\right\}\right)$}\;
}
\end{algorithm}


\begin{lemma}
If $t$ and $t'$ are any two times, $b := \text{highestLMDConfirmedDesc}_v(b_{\text{anchor}}, t)$, $t \leq t'$ and the following holds:
\begin{enumerate}
    \item $\text{st}(\text{slot}(t) - 1) \geq \text{GST},$
    \item $b_{\text{anchor}}$ is canonical in the view of any honest validator $v'$ at time $t,$
    \item $GJ^{t',v} \succeq GJ^{\text{st}(\text{slot}(t) - 1),v},$
    \item $b \in \text{filt}^{t',v'}_{\text{hfc}}$
\end{enumerate}

then $b$ is canonical in the view of any honest validator $v'$ at time $t'$.
\end{lemma}

\begin{proof}
    TBD..
\end{proof}


\begin{algorithm}[H]
\caption{Highest confirmed descendant}
% \SetAlgoLined
\SetAlgoNoLine
\Fn{highestConfirmedDesc$_v(b_{\text{anchor}}, t)$}{
    $b' \gets \text{highestLMDConfirmedDesc}_v(b_{\text{anchor}}, t)$\;
    
    \uIf{$\text{epoch}(t) = \text{epoch}(b') > \text{epoch}(b_{\text{anchor}})$}{
        \uIf{$\text{willChkpBeJustified}_v(C(b'))$ \textbf{and} $\exists b'' \succeq b' : \text{epoch}(GU(b'')) \geq \text{epoch}(t) - 1$}{
            \Return{$b'$}\;
        }
        \uElse{
            \Return{$\max\left(\left\{b'' \in \nu^{v,t} : b_{\text{anchor}} \preceq b'' \prec b' \wedge \text{epoch}(b'') = \text{epoch}(b_{\text{anchor}})\right\}\right)$}\;
        }
    }
    \uElseIf{$\text{epoch}(t) = \text{epoch}(b') = \text{epoch}(b_{\text{anchor}})$}{
        \uIf{$\exists b'' \succeq b' : \text{epoch}(GU(b'')) \geq \text{epoch}(t) - 1$}{
            \Return{$b'$}\;
        }
        \uElse{
            \Return{$b_{\text{anchor}}$}\;
        }
    }
    \uElseIf{$\text{epoch}(t) > \text{epoch}(b')$ \textbf{and} $\text{slot}(t) = \text{first\_slot}(\text{epoch}(t))$}{
        \uIf{$\text{epoch}(GU(b')) \geq \text{epoch}(t) - 2$}{
            \Return{$b'$}\;
        }
        \uElse{
            \Return{$b_{\text{anchor}}$}\;
        }
    }
    \uElse{
        \Return{$b'$}\;
    }
}
\end{algorithm}

\begin{lemma}
If $t$ and $t'$ are any two times such that $t' \geq t \wedge \text{epoch}(t') = \text{epoch}(t)$, $b := \text{highestConfirmedDesc}_v(b_{\text{anchor}}, t)$, $\text{epoch}(b) = \text{epoch}(t) - 1$ and the following holds:

\begin{enumerate}
    \item $\text{st}(\text{epoch}(t) - 1) \geq \text{GST},$
    \item $b_{\text{anchor}}, \text{epoch}(b_{\text{anchor}}) = \text{epoch}(t) - 1$ is canonical in the view of any validator $v'$ at time $\text{st}(\text{slot}(t) - 1),$
    \item At the time $t'' \leq \text{st}(\text{last\_slot}(\text{epoch}(t) - 1))$ in the view of validator $v$ exists block $b' \preceq b : \text{epoch}(b') = \text{epoch}(t) - 1$ such that $\text{willChkpBeJustified}^{t''}_v(C(b')) = \text{True},$
    \item At the time $\text{st}(\text{slot}(t) - 1)$ $\exists b'' \succeq b_{\text{anchor}} : \text{epoch}(b'') = \text{epoch}(t) - 1 \wedge \text{epoch}(GU(b'')) \geq \text{epoch}(t) - 2,$
    \item $GJ^{\text{st}(\text{last\_slot}(\text{epoch}(t) - 1)),v} = C(b, *)$
\end{enumerate}

then $b$ is canonical in the view of any honest validator $v'$ at time $t' < \text{st}(\text{epoch}(b) + 2)$.
\end{lemma}

\begin{proof}
    TBD...
\end{proof}



\begin{lemma}
   If $t$ and $t'$ are any two times such that $t' \geq t$, $b := \text{highestConfirmedDesc}_v(b_{\text{anchor}}, t)$, $\text{epoch}(b) = \text{epoch}(t)$ and the following holds:
    
    \begin{enumerate}
        \item $\text{st}(\text{epoch}(t') - 1) \geq \text{GST},$
        \item $b_{\text{anchor}}$ is canonical in the view of any validator $v'$ at time $t,$
        \item At the time $t'' \leq \text{st}(\text{last\_slot}(\text{epoch}(t)))$ in the view of validator $v$ exists block $b' \preceq b : \text{epoch}(b') = \text{epoch}(t)$ such that:
        \begin{enumerate}
            \item $willChkpBeJustified^{t''}_v(C(b')),$
            \item $\exists b'' \succeq b' : \text{epoch}(b'') = \text{epoch}(t) \wedge \text{epoch}(GU(b'')) \geq \text{epoch}(t) - 1,$
        \end{enumerate}
        \item $GU^{\text{st}(\text{last\_slot}(\text{epoch}(t) - 1)),v} \succeq C(b, \text{epoch}(t) - 2),$
        \item $GJ^{\text{st}(\text{last\_slot}(\text{epoch}(t) - 1)),v} = C(b, *),$
    \end{enumerate}
    
    then $b$ is canonical in the view of any honest validator $v'$ at time $t' < \text{st}(\text{epoch}(b) + 2)$.
\end{lemma}

\begin{proof}
    TBD...
\end{proof}

% \section*{Algorithm 102}
% \textbf{(Highest confirmed)}

Let $V^{v,t}$ be the view of a validator $v$ at the start of $\text{slot}(t)$ to which all the votes cast and observed by $v$ before $\text{st}(\text{slot}(t))$ are applied.

\begin{algorithm}[H]
\SetAlgoNoLine
\Fn{$\text{highestConfirmed}_v(V^{v,t})$}{
    $b' \gets \text{highestConfirmed}(V^{v, \text{st}(\text{slot}(t) - 1)})$\;
    \uIf{$b' \preceq \text{LMD\_GHOST\_HFC}(V^{v,t})$ \textbf{and} $\text{epoch}(b') \geq \text{epoch}(t) - 1$}{
        \Return{$\text{highestConfirmedDesc}_v(b', t)$}\;
    }
    \uElseIf{
        $\text{epoch}(GU(V^{v,t})) = \text{epoch}(t)$ \textbf{and} \\
        $\text{epoch}(GJ(V^{v, \text{st}(\text{slot}(t) - 1)})) = \text{epoch}(t) - 1$ \textbf{and} \\
        $GU(V^{v,t}) \succeq GJ^{\text{st}(\text{slot}(t) - 1), v}$
    }{
        \Return{$\text{highestConfirmedDesc}_v(\text{block}(GU(V^{v,t})), t)$}\;
    }
    \uElse{
        \Return{$b_{\text{fin}}$}\;
    }
}
\caption{Highest Confirmed Block Selection}
\end{algorithm}

\begin{lemma}
    If $t$ and $t'$ are any two times such that $t' \geq t$, $b := \text{highestConfirmed}(V^{v,t})$ and the following holds:
    
    \begin{enumerate}
        \item $\text{st}(\text{epoch}(t) - 1) \geq \text{GST},$
    \end{enumerate}
    
    then $b$ is canonical in the view of any honest validator $v'$ at time $t'$.
\end{lemma}

\begin{proof}
    TBD...
\end{proof}


\begin{lemma}
    If $t$ and $t'$ are any two times such that $t' \geq t$ and the following holds:
    
    \begin{enumerate}
        \item $\text{st}(\text{epoch}(t')) \geq \text{GST},$
        \item $\text{epoch}(GU^{t,v}) = \text{epoch}(t),$
        \item $\text{epoch}(GJ^{\text{st}(\text{slot}(t)-1),v}) = \text{epoch}(t) - 1,$
        \item $GU^{t,v} \succeq GJ^{\text{st}(\text{slot}(t)-1),v},$
    \end{enumerate}
    
then $GU^{t,v}$ is canonical in the view of any honest validator $v'$ at any time $t'$.
\end{lemma}

\begin{proof}
    TBD...

    \begin{description}
        \item[Case 1: $\text{epoch}(t') = \text{epoch}(t)$.]
        \item[Case 2: $\text{epoch}(t') > \text{epoch}(t)$.]  
    \end{description}
\end{proof}

\subsection*{Roberto's suggested Lemmas}

\begin{lemma}
    If
    \begin{enumerate}
        \item $epoch(b_{\text{anchor}}^{v,st(slot(t))}) \geq epoch(t)-2$
    \end{enumerate},
    then
    \begin{enumerate}
        \item $epoch(GJ^{v,st(slot(t))}) \geq epoch(t)-2$
        % \item $b_{\text{anchor}}^{v,st(slot(t))} \succeq GJ^{v,t}$
    \end{enumerate}
\end{lemma}

\begin{lemma}
    If
    \begin{enumerate}
        \item $\text{st}(\text{last\_slot}(\text{epoch}(t) - 1)) \geq GST$
        \item $epoch(b_{\text{anchor}}^{v,st(slot(t))}) \geq epoch(t)-2$
    \end{enumerate},
    then, for any honest validator $v'$,
    \begin{enumerate}
        \item $epoch(GJ^{v',st(slot(t))}) \geq epoch(t)-2$
    \end{enumerate}
\end{lemma}

\begin{lemma}\label{lem:gj-at-least-e-2}
    If
    \begin{enumerate}
        \item $\text{st}(\text{last\_slot}(\text{epoch}(t) - 1)) \geq GST$
        \item $slot(t) > \text{first\_slot}(epoch(t))$
        \item $epoch(b_{\text{anchor}}^{v,st(slot(t))}) \geq epoch(t)-2$
    \end{enumerate},
    then, for any honest validator $v'$,
    \begin{enumerate}
        \item $epoch(GJ^{v',st(slot(t)-1)}) \geq epoch(t)-2$
    \end{enumerate}
\end{lemma}

\begin{lemma}
    If
    \begin{enumerate}
        \item $\text{isOneConfirmed}_v(b, GJ^{v,st(slot(t))}, st(slot(t)))$
        \item $epoch(b) = epoch(t)$
    \end{enumerate},
    then, for any honest validator $v'$ and time $t' \geq t$ such that $epoch(t') = epoch(t)$
    \begin{enumerate}
        \item $b \in \text{filt}^{t',v'}_{\text{hfc}}$
    \end{enumerate}
\end{lemma}

\begin{proof}(Sketch)
    At least one honest validator $v'$ voted for $b$ in the previous slot.
    This also implies that $slot(t) > first_slot(epoch(t))$. 
    Given, \Cref{lem:gj-at-least-e-2} and that $epoch(slot(t)-1) = epoch(t)$,  it must be that $v'$'s view includes a block $b' \succeq b$ such that $epoch(vs(b', st(slot(t)-1))) \geq epoch(t)-2$.
    By $st(slot(t))$, $b'$ is in the view of any honest validator.
    Hence, $b'$ is not filtered out by any honest validator at time $st(slot(t))$ or after during epoch $epoch(t)$.
\end{proof}

\begin{lemma}
    Let $GU^{v,t-1} := GU(V^{v,st(slot(t)-1)},st(slot(t)-1))$.
    If
    \begin{enumerate}
        \item $t = st(epoch(t))$
        \item $epoch(GU^{v,t-1}) = epoch(t)-1$
    \end{enumerate},
    then for any honest validator $v'$ and time $t'$ such that $epoch(t') \in \{epoch(t),epoch(t)+1\}$,
    \begin{enumerate}
        \item $b \in \text{filt}^{t',v'}_{\text{hfc}}$
    \end{enumerate}
\end{lemma}



\end{document}